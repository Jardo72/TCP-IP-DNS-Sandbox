# AWS Infrastructure

## Introduction

Terraform configuration allowing to provision AWS infrastructure that can be used to run the [TCP/IP demo applications](../TCP-UDP). The overall setup is depicted by the following diagram:
![application-diagram](./diagram.png)

The EC2 instances automatically download the Python code from this Git repository upon the start. The entire repo is downloaded to the `/opt` directory. As AWS does not support broadcast and multicast communication, UDP broadcast and UDP multicast applications will not work. However, the other applications work properly. The EC2 instance marked as server in the diagram is supposed to run the server applications (i.e. [TCP Server](../TCP-UDP/tcp_server.py), [UDP Server](../TCP-UDP/udp_server.py), [Hesitant Consumer TCP Server](../TCP-UDP/hesitant_consumer_tcp_server.py)). The EC2 instances marked as client in the diagram are supposed to run the client applications (i.e. [TCP Client](../TCP-UDP/tcp_client.py), [UDP Client](../TCP-UDP/udp_client.py), [Eager Producer TCP Client](../TCP-UDP/eager_producer_tcp_client.py)). The security groups protecting the EC2 instances are configured so that the network traffic is allowed if the instances have the roles described above. If you change the roles (i.e. you let the server instance run the client applications, and you let one of the client instances to run the server applications), you are likely to encounter problems with network traffic being blocked by the security groups.

The VPC is associated with a Route 53 private hosted zone. The Terraform configuration also creates DNS names for the EC2 instances. The DNS names are visible in the outputs generated by the Terraform configuration. The DNS names can be used instead of IP addresses when experimenting with the applications.

Network troubleshooting tools like netstat and tcpdump are installed on all EC2 instances. In addition, all EC2 instances have access to the S3 bucket. Therefore, network captures created with tcpdump can be uploaded to the S3 bucket, so you can download the capture files to your localhost and analyze them with Wireshark.

The EC2 instances are also configured in a way the AWS Systems Manager Session Manager can be used to connect to the EC2 instances. In other words, you can open a terminal window in the AWS Management Console, and you do not have to deal with SSH keys.

## How Create/Destroy the Infrastructure

In order to create the AWS infrastructure, you will need Terraform. You can download and install it from [Install Terraform web site](https://developer.hashicorp.com/terraform/install). When it is installed, you will have setup AWS credentials. Create an AWS access key for user that has sufficient permissions to create the infrastructure. In the terminal window where you want to run Terraform, set/export the following environment variables:

- `AWS_ACCESS_KEY_ID`
- `AWS_SECRET_ACCESS_KEY`

After setting the credentials, you are ready to create the infrastructure with the following commands:

```sh
terraform init
terraform plan
terraform apply -auto-approve
```

When you are ready with the experiments, you want to shutdown the infrastrutcure so that it does not incurr any unnecessary costs. You can do it with the following command:

```sh
terraform destroy -auto-approve
```
